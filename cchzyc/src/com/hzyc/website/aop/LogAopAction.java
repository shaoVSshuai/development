package com.hzyc.website.aop;


import java.lang.reflect.Method;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.servlet.http.HttpServletRequest;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.Signature;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import com.hzyc.website.aop.SystemLog;
import com.hzyc.website.beans.Log;
import com.hzyc.website.services.InitService;
import com.hzyc.website.utils.BeanUtil;

/**
 * 切面类
 */
@Aspect
public class LogAopAction {
	
	//注入初始化service
	private InitService initService;
	
	public void setInitService(InitService initservice){
		this.initService = initservice;
		
	}
	public InitService getInitService(){
		return this.initService;
		
	}
	
    //开始时间
    private long BEGIN_TIME ;

    //结束时间
    private long END_TIME;

    //运行日志
    private Log log = new Log();
    
    //切入点控制在controller层
	@Pointcut("execution(* com.hzyc.website.controllers..*.*(..))")
    private void controllerAspect(){}

    /**
     * 方法执行前操作:记录开始执行时间
     */
    @Before("controllerAspect()")
    public void doBefore(){
        BEGIN_TIME = new Date().getTime();
        System.out.println("方法开始执行..");
    }

    /**
     * 方法执行后操作：记录结束执行时间
     */
    @After("controllerAspect()")
    public void after(){
        END_TIME = new Date().getTime();
        System.out.println("方法结束执行..");
    }

    /**
     * 方法return结束后操作：记录日志
     */
    @AfterReturning("controllerAspect()")
    public void doAfter(){
       SimpleDateFormat sdf = new SimpleDateFormat("YYYY-MM-dd HH:mm:ss");
       log.setActiontime(END_TIME-BEGIN_TIME);
       log.setGmtcreate(sdf.format(new Date(BEGIN_TIME)));
       System.out.println(log);
       LogAopAction laa = (LogAopAction)BeanUtil.getBean("logAop");
       if(log.getState()==1){
	    	laa.getInitService().insertLog(log);
        }else if(log.getState()==-1){
           //执行失败也要记录
	    	laa.getInitService().insertLog(log);
        }
    }

    /**
     * 抛出异常操作
     */
    @AfterThrowing("controllerAspect()")
    public void doAfterThrow(){
        System.out.println("方法执行失败-----------------------------------");
    }

    /**
     * 方法执行
     * @param pjp
     * @return
     * @throws Throwable
     */
    @Around("controllerAspect()")
    public Object around(ProceedingJoinPoint pjp) throws Throwable{
	  //日志实体对象
	    HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
	    //获取当前登陆用户信息
	    if(request.getSession().getAttribute("uid") != null){
	    	log.setLoginaccount(request.getSession().getAttribute("uid").toString());
	    }else{
	    	 log.setLoginaccount("null");;
	    }
	
	    // 拦截的实体类，就是当前正在执行的controller
	    Object target = pjp.getTarget();
	    // 拦截的方法名称。当前正在执行的方法
	    String methodName = pjp.getSignature().getName();
	    // 拦截的方法参数
	    Object[] args = pjp.getArgs();
	    // 拦截的放参数类型
	    Signature sig = pjp.getSignature();
	    MethodSignature msig = null;
	    if (!(sig instanceof MethodSignature)) {
	        throw new IllegalArgumentException("该注解只能用于方法");
	    }
	    msig = (MethodSignature) sig;
	    Class[] parameterTypes = msig.getMethod().getParameterTypes();
	
	    Object object = null;
	
	    Method method = null;
	    try {
	        method = target.getClass().getMethod(methodName, parameterTypes);
	    } catch (NoSuchMethodException e1) {
	        // TODO Auto-generated catch block
	        e1.printStackTrace();
	    } catch (SecurityException e1) {
	        // TODO Auto-generated catch block
	        e1.printStackTrace();
	    }
	
	    if (null != method) {
	        // 判断是否包含自定义的注解，说明一下这里的SystemLog就是我自己自定义的注解
	        if (method.isAnnotationPresent(SystemLog.class)) {
	            SystemLog systemlog = method.getAnnotation(SystemLog.class);
	            log.setModule(systemlog.module());
	            log.setMethod(systemlog.methods());
	            log.setLoginip(getIp(request));
	            log.setActionurl(request.getRequestURI());
	
	            try {
	                object = pjp.proceed();
	                log.setDescription("执行成功");
	                log.setState((short) 1);
	            } catch (Throwable e) {
	            	//记录异常
	            	log.setException(e.toString());
	                // TODO Auto-generated catch block
	                log.setDescription("执行失败");
	                log.setState((short)-1);
	            }
	        } else {//没有包含注解
	            object = pjp.proceed();
	            //log.setDescription("此操作不包含注解");
	            log.setState((short)0);
	        }
	    } else { //不需要拦截直接执行
	        object = pjp.proceed();
	        //log.setDescription("不需要拦截直接执行");
	        log.setState((short)0);
	    }
	    return object;
	}

	/**
	 * 获取ip地址
	 * @param request
	 * @return
	 */
	private String getIp(HttpServletRequest request){
	    if (request.getHeader("x-forwarded-for") == null) {
	        try {
				return InetAddress.getLocalHost().getHostAddress();
			} catch (UnknownHostException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
	    }
	    return request.getHeader("x-forwarded-for");
	}
	    
	
	public static void main(String[] args) {
		try {
			String a = null;
			a.toCharArray();
		} catch (Exception e) {
			// TODO: handle exception
			System.out.println(e);
		}
	}
    
}